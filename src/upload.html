<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <!-- Ensures proper rendering and touch zooming for mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Primary Meta Tags -->
  <title>Upload | Neotropic - Futuristic Image Repository</title>
  <meta name="description" content="Share your dimensional visions with the multiverse on Neotropic, a futuristic image repository.">
  <meta name="keywords" content="futuristic, images, repository, Neotropic, gallery, upload, multiverse, cyberpunk">
  <meta name="author" content="Neotropic">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Upload | Neotropic - Futuristic Image Repository">
  <meta property="og:description" content="Upload your stunning dimensional imagery to Neotropic.">
  <!-- Replace 'image_url.jpg' with your actual image URL -->
  <meta property="og:image" content="https://example.com/image_url.jpg">
  <meta property="og:url" content="https://example.com/neotropic/upload">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Upload | Neotropic - Futuristic Image Repository">
  <meta name="twitter:description" content="Upload your stunning dimensional imagery to Neotropic.">
  <meta name="twitter:image" content="https://example.com/image_url.jpg">

  <!-- Tailwind CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
  />

  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Rajdhani:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Custom CSS Files -->
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="animations.css" />

  <style>
    /* Base body settings */
    body {
      font-family: 'Rajdhani', sans-serif;
      background: linear-gradient(to bottom right, #0f172a, #1e293b);
      color: #e2e8f0;
      margin: 0;
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto;
    }

    /* Neon-grid overlay */
    .neon-grid {
      position: absolute;
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0;
      pointer-events: none;
      z-index: 0;
    }

    /* Container stacking */
    .container {
      position: relative;
      z-index: 1;
    }

    /* Hide default file input */
    #imageInput {
      display: none;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-gray-900 via-indigo-900 to-black min-h-screen text-white font-rajdhani">

  <!-- Navigation -->
  <nav id="navbar" class="glass-nav fixed w-full z-50 p-4">
    <div class="container mx-auto flex justify-between items-center">
      <!-- Logo -->
      <a href="/" class="logo-container">
        <h1
          class="text-3xl font-orbitron font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600"
        >
          NEOTROPIC
        </h1>
        <div class="logo-glow"></div>
      </a>

      <!-- Desktop Nav Links -->
      <div class="hidden md:flex space-x-4">
        <a href="/" class="nav-link">Home</a>
        <a href="home.html" class="nav-link">Gallery</a>
        <a href="upload.html" class="nav-link active">Upload</a>
      </div>

      <!-- Auth Buttons -->
      <div class="auth-buttons">
        <a href="login.html" id="loginBtn" class="cyber-button mr-2">
          <span>Login</span>
          <i></i>
        </a>
        <a href="signup.html" id="signupBtn" class="cyber-button-secondary">
          <span>Sign Up</span>
          <i></i>
        </a>
        <button id="logoutBtn" class="cyber-button-danger hidden">
          <span>Logout</span>
          <i></i>
        </button>
      </div>

      <!-- Mobile Menu Button -->
      <div class="md:hidden">
        <button id="mobileMenuBtn" class="text-white">
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            ></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation Menu -->
    <div
      id="mobileMenu"
      class="glass-menu hidden md:hidden absolute w-full left-0 right-0 mt-4 p-4"
    >
      <a href="/" class="block py-2 px-4 hover:bg-indigo-900 rounded">Home</a>
      <a href="home.html" class="block py-2 px-4 hover:bg-indigo-900 rounded"
        >Gallery</a
      >
      <a href="upload.html" class="block py-2 px-4 hover:bg-indigo-900 rounded"
        >Upload</a
      >
    </div>
  </nav>

  <!-- Success Modal -->
  <div
    id="successModal"
    class="fixed inset-0 z-50 flex items-center justify-center hidden"
  >
    <div class="absolute inset-0 bg-black bg-opacity-80 backdrop-blur-sm"></div>
    <div
      class="relative z-10 glassmorphism-card rounded-2xl w-11/12 max-w-md p-8 text-center"
    >
      <div class="success-animation mb-6">
        <div class="checkmark-circle">
          <div class="checkmark"></div>
        </div>
      </div>
      <h3
        class="text-2xl font-orbitron font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500"
      >
        Upload Successful!
      </h3>
      <p class="text-blue-100 mb-8">
        Your dimensional image has been successfully transmitted.
      </p>
      <div class="flex space-x-4 justify-center">
        <a href="home.html" class="cyber-button">
          <span>View Gallery</span>
          <i></i>
        </a>
        <button id="uploadAnother" class="cyber-button-secondary">
          <span>Upload Another</span>
          <i></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Upload Section -->
  <section
    class="min-h-screen flex items-center justify-center px-4 py-20 relative"
  >
    <div class="neon-grid"></div>
    <div class="container max-w-4xl mx-auto">
      <div class="text-center mb-10">
        <h1
          class="text-4xl md:text-5xl font-orbitron font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-600"
        >
          UPLOAD IMAGE
        </h1>
        <p class="text-lg text-blue-200">
          Share your dimensional visions with the multiverse
        </p>
      </div>

      <!-- If user is NOT authenticated -->
      <div
        id="unauthenticatedMessage"
        class="glassmorphism-card p-8 rounded-2xl text-center hidden"
      >
        <h3
          class="text-2xl font-orbitron font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-pink-600"
        >
          Authentication Required
        </h3>
        <p class="text-blue-100 mb-6">
          You need to be logged in to upload images to the dimensional
          repository.
        </p>
        <div class="flex justify-center space-x-4">
          <a href="login.html" class="cyber-button">
            <span>Login</span>
            <i></i>
          </a>
          <a href="signup.html" class="cyber-button-secondary">
            <span>Sign Up</span>
            <i></i>
          </a>
        </div>
      </div>

      <!-- Upload Form (Shown only if Authenticated) -->
      <div
        id="uploadForm"
        class="glassmorphism-card p-8 rounded-2xl hidden"
      >
        <div id="uploadAlert" class="hidden rounded-lg p-4 mb-6"></div>

        <form id="imageUploadForm">
          <!-- Image Preview / Drop Zone -->
          <div class="mb-8">
            <div
              id="dropArea"
              class="border-2 border-dashed border-indigo-600 rounded-xl flex flex-col items-center justify-center p-8 transition-all cursor-pointer hover:border-purple-500 hover:bg-indigo-900/20"
            >
              <div
                id="previewContainer"
                class="w-full flex items-center justify-center"
              >
                <div id="placeholderContainer" class="text-center">
                  <svg
                    class="w-20 h-20 mx-auto text-indigo-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="1"
                      d="M4 16l4.586-4.586a2 2 0 012.828 0L16
                        16m-2-2l1.586-1.586a2 2 0 012.828 0L20
                        14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2
                        0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002
                        2z"
                    ></path>
                  </svg>
                  <p class="mt-4 text-lg text-blue-300">
                    Drag &amp; drop an image or click to browse
                  </p>
                  <p class="mt-2 text-sm text-blue-400">
                    Supports JPG, PNG, GIF, WEBP
                  </p>
                </div>
                <img
                  id="imagePreview"
                  class="hidden max-h-80 rounded-lg object-contain"
                  alt="Image preview"
                />
              </div>
              <input
                type="file"
                id="imageInput"
                class="hidden"
                accept="image/jpeg,image/png,image/gif,image/webp"
              />
            </div>
            <div id="removePreview" class="mt-2 text-center hidden">
              <button
                type="button"
                class="text-red-400 hover:text-red-300 transition text-sm"
              >
                Remove image
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Title -->
            <div class="col-span-full">
              <div class="cyber-input-container">
                <input
                  type="text"
                  id="title"
                  required
                  class="cyber-input"
                  placeholder=" "
                />
                <label for="title" class="cyber-label">TITLE</label>
                <div class="cyber-input-border"></div>
              </div>
            </div>

            <!-- Category -->
            <div class="md:col-span-1">
              <select
                id="category"
                class="cyber-select w-full"
                required
              >
                <option value="" disabled selected>Select Category</option>
                <option value="Nature">Nature</option>
                <option value="Space">Space</option>
                <option value="Cyberpunk">Cyberpunk</option>
                <option value="Abstract">Abstract</option>
              </select>
            </div>

            <!-- Description (Optional) -->
            <div class="col-span-full">
              <div class="cyber-textarea-container">
                <textarea
                  id="description"
                  class="cyber-textarea"
                  rows="4"
                  placeholder=" "
                ></textarea>
                <label for="description" class="cyber-label">DESCRIPTION (OPTIONAL)</label>
                <div class="cyber-textarea-border"></div>
              </div>
            </div>

            <div class="col-span-full text-center mt-6">
              <button
                type="submit"
                id="submitButton"
                class="cyber-button-large"
                disabled
              >
                <span>UPLOAD TO REPOSITORY</span>
                <i></i>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="py-8 px-4 border-t border-indigo-800 mt-10">
    <div class="container mx-auto">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="mb-4 md:mb-0">
          <h2
            class="text-2xl font-orbitron font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600"
          >
            NEOTROPIC
          </h2>
          <p class="text-blue-200">Futuristic Image Repository</p>
        </div>
        <div class="flex space-x-6">
          <a href="#" class="text-blue-300 hover:text-white transition">About</a>
          <a href="#" class="text-blue-300 hover:text-white transition">Privacy</a>
          <a href="#" class="text-blue-300 hover:text-white transition">Terms</a>
          <a href="#" class="text-blue-300 hover:text-white transition">Contact</a>
        </div>
      </div>
      <div class="mt-8 text-center text-blue-400">
        <p>&copy; 2025 Neotropic. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Toggle Mobile Menu Script -->
  <script>
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');

    mobileMenuBtn.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden');
    });
  </script>

  <!-- Supabase + Upload Logic -->
  <script type="module">
    import { supabase } from "../supabase.js"; // Adjust path if needed

    // DOM references
    const unauthenticatedMessage = document.getElementById("unauthenticatedMessage");
    const uploadFormWrapper      = document.getElementById("uploadForm");
    const submitButton           = document.getElementById("submitButton");
    const dropArea               = document.getElementById("dropArea");
    const imageInput             = document.getElementById("imageInput");
    const placeholderContainer   = document.getElementById("placeholderContainer");
    const imagePreview           = document.getElementById("imagePreview");
    const removePreviewBtn       = document.getElementById("removePreview");
    const successModal           = document.getElementById("successModal");
    const uploadAnotherBtn       = document.getElementById("uploadAnother");

    // Check auth on DOM load
    document.addEventListener("DOMContentLoaded", async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        // Not logged in => show the "unauthenticated" card
        unauthenticatedMessage.classList.remove("hidden");
        uploadFormWrapper.classList.add("hidden");
      } else {
        // Authenticated => show upload form
        unauthenticatedMessage.classList.add("hidden");
        uploadFormWrapper.classList.remove("hidden");
        submitButton.disabled = false;
      }
    });

    // Drag & drop or click to select image
    dropArea.addEventListener("click", () => {
      imageInput.click();
    });
    dropArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropArea.classList.add("border-purple-500");
    });
    dropArea.addEventListener("dragleave", () => {
      dropArea.classList.remove("border-purple-500");
    });
    dropArea.addEventListener("drop", (e) => {
      e.preventDefault();
      dropArea.classList.remove("border-purple-500");
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });
    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (file) handleFile(file);
    });

    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = (evt) => {
        imagePreview.src = evt.target.result;
        imagePreview.classList.remove("hidden");
        placeholderContainer.classList.add("hidden");
        removePreviewBtn.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    }

    // Remove image
    removePreviewBtn.addEventListener("click", () => {
      imageInput.value = "";
      imagePreview.src = "#";
      imagePreview.classList.add("hidden");
      placeholderContainer.classList.remove("hidden");
      removePreviewBtn.classList.add("hidden");
    });

    // Handle form submission
    const imageUploadForm = document.getElementById("imageUploadForm");
    imageUploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const file = imageInput.files[0];
      if (!file) {
        alert("Please select an image to upload");
        return;
      }

      const title       = document.getElementById("title").value.trim();
      const category    = document.getElementById("category").value;
      const description = document.getElementById("description").value.trim();

      // 1) Upload to Supabase Storage (bucket: "images")
      const fileExt  = file.name.split(".").pop();
      const filePath = `${Date.now()}.${fileExt}`; // unique name
      const { data: uploadData, error: uploadError } = await supabase
        .storage
        .from("images") 
        .upload(filePath, file);

      if (uploadError) {
        console.error("Upload failed:", uploadError);
        alert("Upload failed: " + uploadError.message);
        return;
      }

      // 2) Get public URL
      const { data: urlData, error: urlError } = supabase
        .storage
        .from("images")
        .getPublicUrl(filePath);

      if (urlError) {
        console.error("Failed to get public URL:", urlError);
        alert("Failed to get public URL: " + urlError.message);
        return;
      }

      // 3) Insert metadata into your 'images' table
      const publicURL = urlData.publicUrl;
      const { data: insertData, error: insertError } = await supabase
        .from("images")
        .insert([
          {
            filename: file.name,
            title: title,
            url: publicURL,
            uploaded_at: new Date().toISOString(),
            category: category,
            description: description
          }
        ]);

      if (insertError) {
        console.error("Failed to save image metadata:", insertError);
        alert("Failed to save image metadata: " + insertError.message);
        return;
      }

      // Show success modal
      successModal.classList.remove("hidden");
    });

    // "Upload Another" button resets form
    uploadAnotherBtn.addEventListener("click", () => {
      successModal.classList.add("hidden");

      // Reset form fields
      imagePreview.src = "";
      imagePreview.classList.add("hidden");
      placeholderContainer.classList.remove("hidden");
      removePreviewBtn.classList.add("hidden");
      imageInput.value = null;
      document.getElementById("title").value = "";
      document.getElementById("description").value = "";
      document.getElementById("category").selectedIndex = 0;
    });
  </script>
</body>
</html>
